#! /bin/sh

##########################
## Regular derivation.  ##
##########################

## ----------------- ##
## derivation(exp).  ##
## ----------------- ##

# check RAT-EXP STRING RESULT
# ---------------------------
# Check that the derivation of RAT-EXP by STRING is RESULT.
check ()
{
  local re
  case $1 in
    ('(?@'*) re=$1;;
    (*)      re="(?@lal_char(abc)_ratexpset<lal_char(xyz)_z>)$1";;
  esac
  run 0 "$3" -vcsn-derivation -e "$re" "$2"
}

## ---------------------------- ##
## Derive wrt a single letter.  ##
## ---------------------------- ##

# Zero, one.
check    '\z' a '\z'
check    '\e' a '\z'
check '<x>\e' a '\z'

# Letters.
check    'a' a '\e'
check    'a' b '\z'
check '<x>a' a '<x>\e'
check '<x>a' b '\z'

# Sum.
check '<x>a+<y>b' a '<x>\e'
check '<x>a+<y>b' b '<y>\e'
check '<x>a+<y>a' a '<x+y>\e'

# Prod.
check 'ab' 'a' 'b'
check 'ab' 'b' '\z'
check '(<x>a).(<y>a).(<z>a)' 'a' '<x><y>a.<z>a'

# Star.
check 'a*' a 'a*'
check 'a*' b '\z'
check '(<x>a)*' a '<x>(<x>a)*'
check '(<x>a)*' b '\z'
check '<x>a*'   a '<x>a*'
check '<x>(<y>a)*' a '<x.y>(<y>a)*'


## ------------------------------- ##
## Derive wrt to several letters.  ##
## ------------------------------- ##

check '(<x>a)*' aa   '<x.x>(<x>a)*'
check '(<x>a)*' aaaa '<x.x.x.x>(<x>a)*'
check '(<x>a)*' aaab '\z'

check '(<x>a)*(<y>b)*' aa   '<x.x>(<x>a)*.(<y>b)*'
check '(<x>a)*(<y>b)*' aabb '<x.x.y.y>(<y>b)*'


## -------------------- ##
## Classical examples.  ##
## -------------------- ##

# EAT, Example 4.3.
E1='(<1/6>a*+<1/3>b*)*'
# E1 typed.
E1t="(?@lal_char(ab)_q)$E1"
check "$E1t"  a  "<1/3>a*.$E1"
check "$E1t"  b  "<2/3>b*.$E1"
check "$E1t" aa  "<4/9>a*.$E1"
check "$E1t" ab  "<2/9>b*.$E1"
check "$E1t" ba  "<2/9>a*.$E1"
check "$E1t" bb "<10/9>b*.$E1"


## ------------------- ##
## derived_term(exp).  ##
## ------------------- ##

export VCSN_ORIGINS=1
run 0 -f $medir/e1-dt.gv -vcsn-derived-term -e "$E1t"
unset VCSN_ORIGINS

# Make sure that "\e" is properly escaped.
export VCSN_ORIGINS=1
run 0 -f $medir/'a?-dt'.gv -vcsn-derived-term -e "a?"
unset VCSN_ORIGINS


###########################
## Breaking derivation.  ##
###########################


## -------------------------- ##
## breaking-derivation(exp).  ##
## -------------------------- ##

# check_br RAT-EXP STRING RESULT
# ------------------------------
# Check that the breaking derivation of RAT-EXP by STRING is RESULT.
check_br ()
{
  local re
  case $1 in
    ('(?@'*) re=$1;;
    (*)      re="(?@lal_char(abc)_ratexpset<lal_char(xyz)_z>)$1";;
  esac
  export VCSN_BREAKING=1
  run 0 "$3" -vcsn-derivation -e "$re" "$2"
  unset VCSN_BREAKING
}

## ---------------------------- ##
## Derive wrt a single letter.  ##
## ---------------------------- ##

# Zero, one.
check_br    '\z' a '\z'
check_br    '\e' a '\z'
check_br '<x>\e' a '\z'

# Letters.
check_br    'a' a '\e'
check_br    'a' b '\z'
check_br '<x>a' a '<x>\e'
check_br '<x>a' b '\z'

# Sum.
check_br '<x>a+<y>b' a '<x>\e'
check_br '<x>a+<y>b' b '<y>\e'
check_br '<x>a+<y>a' a '<x+y>\e'

# Prod.
check_br 'ab' 'a' 'b'
check_br 'ab' 'b' '\z'
check_br '(<x>a).(<y>a).(<z>a)' 'a' '<x.y>a.<z>a'

# Star.
check_br 'a*' a 'a*'
check_br 'a*' b '\z'
check_br '(<x>a)*' a '<x>(<x>a)*'
check_br '(<x>a)*' b '\z'
check_br '<x>a*'   a '<x>a*'
check_br '<x>(<y>a)*' a '<x.y>(<y>a)*'

## --------------------- ##
## Documented examples.  ##
## --------------------- ##

# On The Number Of Broken Derived Terms Of A Rational Expression.
F2='a*+b*'
E2="($F2)(a($F2))"
E2t="(?@lal_char(ab)_b)$E2"
check "$E2t" a "$F2 + a*.a.($F2)"
check "$E2t" b "b*.a.($F2)"

# Example 2.
check "$E2t" aa "a*+b* + a*.a.($F2) + a*"
check "$E2t" ab 'b*'
check "$E2t" ba "$F2"
check "$E2t" bb "b*.a.($F2)"

# Example 3.
export VCSN_ORIGINS=1
run 0 -f $medir/e2-dt.gv -vcsn-derived-term -e "$E2t"
unset VCSN_ORIGINS

# Example 4.
run 0 "a*.a.($F2) + b*.a.($F2)" -vcsn-split -e "$E2"
run 0 "a* + b*" -vcsn-split -e "$F2"

# Example 5.
check_br "$E2t"  a "a*.a.($F2) + a* + b*"
check_br "$E2t"  b "b*.a.($F2)"
check_br "$E2t" aa "a*.a.($F2) + a* + b*"
check_br "$E2t" ab 'b*'
check_br "$E2t" ba "a* + b*"
check_br "$E2t" bb "b*.a.($F2)"
export VCSN_BREAKING=1 VCSN_ORIGINS=1
run 0 -f $medir/e2-dt-breaking.gv -vcsn-derived-term -e "$E2t"
unset VCSN_BREAKING VCSN_ORIGINS

# Figure 3.
export VCSN_ORIGINS=1
run 0 -f $medir/h3-dt.gv -vcsn-derived-term -e 'a(b+c+d)'
export VCSN_BREAKING=1
run 0 -f $medir/h3-dt-breaking.gv -vcsn-derived-term -e 'a(b+c+d)'
unset VCSN_BREAKING
unset VCSN_ORIGINS
