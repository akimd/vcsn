#! /usr/bin/env python

# A very rough utility to update a test file from its log file.  This
# is very handy when there is a change of syntax: changing every
# single expected output is tedious and error-prone.
#
# usage:
#   update-test --builddir=_build tests/python/*.py

from __future__ import print_function
import argparse, os, re, sys

parser = argparse.ArgumentParser(description='Update test cases.')
parser.add_argument('tests', metavar='test', nargs='+',
                    type=str, default=None,
                    help='a test file to update')
parser.add_argument('--builddir', metavar='DIR',
                    type=str, default=None,
                    help='look for the logs in DIR')
parser.add_argument('--log', metavar='FILE', nargs="+",
                    type=str, default=[],
                    help='consider DIR/FILE')

args = parser.parse_args()

subst = dict()

def diff_to_re(match):
  '''Convert a portion of patch into a regex substitution to perform.
  '''
  frm = []
  to  = []
  is_diff = False
  for l in match.group(1).splitlines():
    # t in [-+ ]
    t = l[1]
    l = l[2:]
    print(t, "=>", l, file=sys.stderr)
    if t in ['-', ' ']:
      is_diff = True
      frm.append(l)
    if t in ['+', ' ']:
      is_diff = True
      to.append(l)
  if is_diff:
    frm = "\n".join(frm)
    to = "\n".join(to)
    print(frm, "=>", to, file=sys.stderr)
    global subst
    subst[frm] = to

def update(test, log):
  try:
    log = open(args.builddir + '/' + log).read()
    global subst
    subst = dict()
    re.sub(r'((?:^\t[-+ ].*\n)+)',
           diff_to_re, log, flags = re.MULTILINE)
    if subst != dict():
      # Turn "subst{frm} => to" into a large RE.
      frm = '|'.join(map(re.escape, subst.keys()))
      test = re.sub(r'''(?<=['"\n])({frm})(?=['"\n])'''.format(frm=frm),
                   lambda m: subst[m.group(1)],
                   test, flags = re.MULTILINE)
    return test
  except:
    return test

for t in args.tests:
  old = open(t).read()
  new = old
  for l in args.log + [t[:t.rfind('.')] + '.log']:
    print(l)
    new = update(new, l)
  if new != old:
    open(t, 'w').write(new)
