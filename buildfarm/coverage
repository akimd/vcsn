#!/bin/sh

set -e
. $(dirname "$0")/common

cd "$DIR_BUILD"

# --no-external was introduced in lcov 1.10.
if lcov --no-external --version; then
  no_external=--no-external
fi

lcov --capture                                  \
     --base-directory $DIR_SOURCE               \
     --directory .                              \
     $no_external                               \
     --output vcsn2.info

# genhtml fails if it can't find some source files.  And it appears
# that it can't find sources in the build tree.  Probably related to
# the fact that these two flex-generated scanners have a #line with
# that path as path.
ln -sf "$DIR_BUILD/lib/vcsn/dot/scan.cc" "$DIR_SOURCE/lib/vcsn/dot/scan.cc"
ln -sf "$DIR_BUILD/lib/vcsn/rat/scan.cc" "$DIR_SOURCE/lib/vcsn/rat/scan.cc"

genhtml --legend --demangle-cpp                 \
     --output-directory vcsn2.cov.html          \
     vcsn2.info
