#! /bin/sh

: ${PYTHON='@PYTHON@'}
export PYTHON

# _Append_ VCSN_PYTHONDIR, not prepend, so that the user can still override this
# path via $PYTHONPATH.  Note in particular that the builddir-tests need to
# override $PYTHONPATH to use non-installed modules, which would them be
# overriden here and installed files would be used instead.
: ${VCSN_PYTHONDIR='@PYEXECDIR@'}
export VCSN_PYTHONDIR
PYTHONPATH=$PYTHONPATH:$VCSN_PYTHONDIR
export PYTHONPATH

# Used by commands such as vcsn-notebook.  Avoids the need for a
# vcsn-notebook.in.
: ${VCSN_DATADIR='@DATADIR@'}
export VCSN_DATADIR

# Where our auxiliary executables are.
: ${VCSN_LIBEXECDIR='@LIBEXECDIR@'}
export VCSN_LIBEXECDIR

# If we are not installed, set the dynamic library path.
if test x"$VCSN_DYLD_LIBRARY_PATH" != x; then
  DYLD_LIBRARY_PATH=$VCSN_DYLD_LIBRARY_PATH
  export DYLD_LIBRARY_PATH
fi

# If there are environment variables that we wish to set, do it now.
# For instance VCSN_ENV=LD_PRELOAD=libclang_rt.asan-x86_64.so`.
if test x"$VCSN_ENV" != x; then
  save_IFS=$IFS
  IFS=';'
  for v in $VCSN_ENV
  do
    eval "export $v"
  done
  IFS=$save_IFS
fi

# Find our auxiliary executables.
PATH=$VCSN_LIBEXECDIR:$PATH
export PATH

help ()
{
  cat <<EOF
usage: vcsn COMMAND ARGS...

If COMMAND is "notebook", run Vcsn as an IPython Notebook.

If COMMAND is "run" (or "-e"), set up the environment to find
Vcsn, and run the ARGS...

If COMMAND is "efstcompile", "efstdecompile", "python", or "ipython",
run the corresponding program.

If COMMAND is "gdb", run gdb with a type pretty-printer.

If COMMAND is one of the following commands, run the corresponding
TAF-Kit program:

  accessible are-equivalent are-isomorphic cat coaccessible complement
  complete compose constant-term conjunction derivation derived-term
  de-bruijn divkbaseb determinize difference divkbaseb double-ring
  eliminate-state enumerate evaluate expand inductive infiltration
  is-ambiguous is-complete is-deterministic is-empty is-eps-acyclic
  is-normalized is-proper is-standard is-trim is-useless is-valid
  ladybird left-mult lift minimize multiply proper quotkbaseb
  right-mult shortest shuffle split standard star star-normal-form sum
  thompson to-expression transpose trim u union universal

For more information, run:

  $ vcsn COMMAND -h

For instance:

  $ vcsn derived-term -C 'lal_char(abc), b' -e '(a+b+a)*' |
     vcsn determinize |
     vcsn minimize |
     vcsn to-expression
EOF
  exit 0
}

version ()
{
cat <<EOF
vcsn (@PACKAGE_STRING@)
<@PACKAGE_URL@>
EOF
  exit 0
}


if test $# = 0; then
  cat >&2 <<EOF
vcsn: missing file operand
Try 'vcsn --help' for more information.
EOF
  exit 1
fi

case $1 in
  ('--export') ;; # We are sourced to set up the environment.
  (-e|run) shift 1; exec "$@";;
  (-h|--help) help;;
  (-v|--version) version;;

  (compile|demangle|ps|score|score-compare)
      prog=$(which "vcsn-$1")
      shift
      exec "$PYTHON" "$prog" "$@";;

  (efstcompile|efstdecompile)
      exec "$@";;

  (python) shift; exec "$PYTHON" "$@";;
  (python*|ipython*|jupyter*) exec "$@";;

  (accessible|are-equivalent|are-isomorphic \
      |cat|chain|coaccessible|complement|complete \
      |compose|conjunction \
      |de-bruijn \
      |derivation|derived-term|determinize \
      |difference|divkbaseb \
      |double-ring \
      |eliminate-state|enumerate|evaluate|expand \
      |infiltration \
      |is-ambiguous|is-complete|is-deterministic \
      |is-empty|is-eps-acyclic|is-normalized|is-proper \
      |is-standard|is-trim|is-useless|is-valid \
      |ladybird|left-mult|lift \
      |minimize \
      |multiply \
      |proper \
      |quotkbaseb \
      |random|right-mult \
      |shuffle|shortest|split|standard|star|star-normal-form|sum \
      |thompson \
      |to-expression \
      |transpose|trim \
      |u|union|universal)
     cmd=$(echo "$1" | sed -e 's/-/_/g')
     shift
     exec vcsn-tafkit "$cmd" "$@";;

  (*)
     prog=vcsn-$1; shift; exec "$prog" "$@";;
esac

# Local Variables:
# mode: shell-script
# End:
